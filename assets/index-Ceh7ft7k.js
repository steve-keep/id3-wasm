(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function r(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(e){if(e.ep)return;e.ep=!0;const t=r(e);fetch(e.href,t)}})();const C=document.getElementById("start-button"),a=document.getElementById("stop-button"),m=document.getElementById("timing-output"),L=document.getElementById("worker-count-output"),k=document.querySelector("#metadata-table tbody");let l=!1;async function*P(s){if(l)for await(const n of s.values()){if(!l)return;n.kind==="file"&&n.name.endsWith(".mp3")?yield n.getFile():n.kind==="directory"&&(yield*P(n))}}function x(s,n){const r=document.createElement("tr"),c=document.createElement("td");c.textContent=n.title||n.fileName||"Unknown",r.appendChild(c);const e=document.createElement("td");e.textContent=n.artist||"Unknown",r.appendChild(e);const t=document.createElement("td");t.textContent=n.album||"Unknown",r.appendChild(t);const i=document.createElement("td");i.textContent=n.year||"Unknown",r.appendChild(i);const p=document.createElement("td");p.textContent=n.genre||"Unknown",r.appendChild(p),s.appendChild(r)}C.addEventListener("click",async()=>{if(!window.showDirectoryPicker){alert("File System Access API is not supported in this browser.");return}if(!l)try{const s=await window.showDirectoryPicker();l=!0,C.disabled=!0,a.style.display="inline-block",a.disabled=!1,k.innerHTML="",m.textContent="Starting scan...";const n=Math.max(1,(navigator.hardwareConcurrency||2)-1);L.textContent=`Using ${n} workers.`;const r=[],c=P(s),e=new Map;let t=0,i=0;const p=performance.now();let d=document.createDocumentFragment(),y=0;await new Promise(h=>{let w=0,N=!1;const v=()=>{N&&w===0&&(y>0&&k.appendChild(d),h())},b=async u=>{if(!l){v();return}const o=await c.next();if(o.done){N=!0,v();return}i++,w++,e.set(u,o.value.name),u.postMessage({type:"process",payload:{file:o.value,HEAD_CHUNK_SIZE:4096}})};for(let u=0;u<n;u++){const o=new Worker(new URL("/id3-wasm/assets/worker-BvN8Zjag.js",import.meta.url));r.push(o),o.onmessage=E=>{const{type:f,payload:g}=E.data;if(f==="ready"){b(o);return}t++,w--,e.delete(o),f==="result"?x(d,{...g.metadata,fileName:g.fileName}):f==="error"&&(x(d,{fileName:g.fileName}),console.error(g.message)),y++,y>=100&&(k.appendChild(d),d=document.createDocumentFragment(),y=0),m.textContent=`Scanning... Processed ${t} of ${i} files found.`,b(o)},o.onerror=E=>{console.error("Worker error:",E),t++,w--;const f=e.get(o)||"Unknown file";x(d,{fileName:f}),e.delete(o),b(o)}}}),r.forEach(h=>h.terminate()),l=!1,C.disabled=!1,a.style.display="none";const F=(performance.now()-p)/1e3;a.disabled?m.textContent=`Scan stopped. Processed ${t} files in ${F.toFixed(2)} seconds.`:m.textContent=`Scanned ${t} files in ${F.toFixed(2)} seconds.`}catch(s){l=!1,C.disabled=!1,a.style.display="none",s.name!=="AbortError"&&(console.error("Error selecting directory:",s),m.textContent=`Error: ${s.message}`)}});a.addEventListener("click",()=>{l=!1,a.disabled=!0});
